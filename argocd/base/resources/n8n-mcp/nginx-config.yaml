apiVersion: v1
kind: ConfigMap
metadata:
  name: n8n-mcp-nginx
  namespace: n8n-mcp
data:
  nginx.conf: |
    worker_processes 1;
    error_log /dev/stderr warn;
    pid /tmp/nginx.pid;

    events {
        worker_connections 1024;
    }

    http {
        access_log /dev/stdout;
        client_body_temp_path /tmp/client_body;
        proxy_temp_path /tmp/proxy;
        fastcgi_temp_path /tmp/fastcgi;
        uwsgi_temp_path /tmp/uwsgi;
        scgi_temp_path /tmp/scgi;

        # Load the expected token from file
        map $http_authorization $auth_valid {
            default 0;
            "~^Bearer (?<token>.+)$" $token;
        }

        server {
            listen 8080;

            # Health check endpoint (no auth required)
            location /healthz {
                return 200 'ok';
                add_header Content-Type text/plain;
            }

            # All other requests require valid Bearer token
            location / {
                # Read expected token from mounted secret
                set_by_lua_block $expected_token {
                    local f = io.open("/etc/nginx/auth/token", "r")
                    if f then
                        local token = f:read("*all"):gsub("%s+", "")
                        f:close()
                        return token
                    end
                    return ""
                }

                # Validate token
                access_by_lua_block {
                    local auth = ngx.var.http_authorization
                    if not auth then
                        ngx.status = 401
                        ngx.header["WWW-Authenticate"] = 'Bearer realm="n8n-mcp"'
                        ngx.say('{"error": "Authorization header required"}')
                        return ngx.exit(401)
                    end

                    local token = auth:match("^Bearer%s+(.+)$")
                    if not token or token ~= ngx.var.expected_token then
                        ngx.status = 403
                        ngx.say('{"error": "Invalid token"}')
                        return ngx.exit(403)
                    end
                }

                # Proxy to MCP server
                proxy_pass http://127.0.0.1:3000;
                proxy_http_version 1.1;
                proxy_set_header Host 127.0.0.1:3000;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;

                # SSE support
                proxy_set_header Connection '';
                proxy_buffering off;
                proxy_cache off;
                chunked_transfer_encoding off;
                proxy_read_timeout 86400s;
            }
        }
    }
