apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Generate ConfigMap from external JS file for better maintainability
configMapGenerator:
  - name: n8n-hooks
    namespace: n8n
    files:
      - hooks.js=resources/n8n/hooks.js
    options:
      disableNameSuffixHash: true

resources:
  # Projects (for multi-tenancy)
  - projects/landing-project.yaml
  # Apps
  - apps/root-app.yaml
  - apps/infrastructure/argocd.yaml
  - apps/infrastructure/argocd-route.yaml
  - apps/infrastructure/cilium-gateway.yaml
  - apps/infrastructure/cloudnative-pg.yaml
  - apps/infrastructure/keycloak-operator.yaml
  - apps/infrastructure/postgres-cluster.yaml
  - apps/infrastructure/reloader.yaml
  - apps/infrastructure/argocd-image-updater.yaml
  - apps/monitoring/loki-stack.yaml
  - apps/monitoring/prometheus.yaml
  # n8n apps
  - apps/n8n/n8n.yaml
  - apps/n8n/oauth2-proxy.yaml
  # Uptime Kuma
  - apps/uptime-kuma/uptime-kuma.yaml
  # Landing page
  - apps/landing/landing.yaml
  # Playwright MCP server
  - apps/playwright-mcp/playwright-mcp.yaml
  # Resources (only those NOT managed by child apps)
  - resources/cert-manager/cluster-issuer.yaml
  # Keycloak via operator CRDs (no child app for these)
  - resources/keycloak/instance.yaml
  - resources/keycloak/realm-import.yaml
  - resources/keycloak/route.yaml
  # Monitoring resources
  - resources/monitoring/prometheus-datasource.yaml
  # n8n resources (namespace, jobs, routes)
  # Note: n8n-hooks ConfigMap is generated via configMapGenerator from hooks.js
  - resources/n8n/namespace.yaml
  - resources/n8n/keycloak-secret-sync.yaml
  - resources/n8n/postgres-init.yaml
  - resources/n8n/route.yaml
  # Uptime Kuma resources
  - resources/uptime-kuma/route.yaml
  # All secrets are in overlay secrets.sops.yaml
  # NOTE: gateway, postgres/cluster, and routes are managed by child apps
