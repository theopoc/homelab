apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Inherit from base
resources:
  - ../../base
  - n8n-client-setup.yaml

# KSOPS generator for SOPS-encrypted secrets
# ArgoCD decrypts via KSOPS plugin, kubectl skips this
generators:
  - ksops-generator.yaml

# Domain configuration
configMapGenerator:
  - name: cluster-config
    namespace: default
    literals:
      - domain=etcd.me
      - repo-url=https://github.com/sofianedjerbi/homelab
      - overlay-path=argocd/overlays/etcdme-nbg1-dc3
      - gateway-path=argocd/overlays/etcdme-nbg1-dc3/resources/gateway
      - routes-path=argocd/overlays/etcdme-nbg1-dc3/resources/routes

# Repository configuration - replace placeholders only in apps that use them
replacements:
  - source:
      kind: ConfigMap
      name: cluster-config
      fieldPath: data.repo-url
    targets:
      - select:
          kind: Application
          name: root-app
        fieldPaths:
          - spec.source.repoURL
      - select:
          kind: Application
          name: cilium-gateway
        fieldPaths:
          - spec.source.repoURL
      - select:
          kind: Application
          name: postgres-cluster
        fieldPaths:
          - spec.source.repoURL
      - select:
          kind: Application
          name: argocd-routes
        fieldPaths:
          - spec.source.repoURL
  - source:
      kind: ConfigMap
      name: cluster-config
      fieldPath: data.overlay-path
    targets:
      - select:
          kind: Application
          name: root-app
        fieldPaths:
          - spec.source.path
  - source:
      kind: ConfigMap
      name: cluster-config
      fieldPath: data.gateway-path
    targets:
      - select:
          kind: Application
          name: cilium-gateway
        fieldPaths:
          - spec.source.path
  - source:
      kind: ConfigMap
      name: cluster-config
      fieldPath: data.routes-path
    targets:
      - select:
          kind: Application
          name: argocd-routes
        fieldPaths:
          - spec.source.path

# Patches to replace domain in various resources
# Note: Gateway patches are in overlays/etcdme-nbg1-dc3/resources/gateway/kustomization.yaml
# Note: Route patches are in overlays/etcdme-nbg1-dc3/resources/routes/kustomization.yaml
patches:
  # keycloak-route is managed by root-app, not argocd-routes
  - target:
      kind: HTTPRoute
      name: keycloak-route
    patch: |
      - op: replace
        path: /spec/hostnames/0
        value: auth.etcd.me

  # Keycloak instance - hostname
  - target:
      kind: Keycloak
      name: keycloak
    patch: |
      - op: replace
        path: /spec/hostname/hostname
        value: auth.etcd.me

  # n8n route - hostname + SSO logout redirect
  - target:
      kind: HTTPRoute
      name: n8n-route
    patch: |
      - op: replace
        path: /spec/hostnames/0
        value: n8n.etcd.me
      - op: add
        path: /spec/rules/0
        value:
          matches:
            - path:
                type: Exact
                value: /signout
          filters:
            - type: RequestRedirect
              requestRedirect:
                path:
                  type: ReplaceFullPath
                  replaceFullPath: /oauth2/sign_out?rd=https%3A%2F%2Fauth.etcd.me%2Frealms%2Fhomelab%2Fprotocol%2Fopenid-connect%2Flogout%3Fclient_id%3Dn8n
                statusCode: 302

# Files that are too complex to patch - override entirely
  - path: realm-import.yaml
  - path: loki-stack-app.yaml
  - path: argocd-app.yaml
  - path: cluster-issuer.yaml
  - path: n8n-app.yaml
  - path: n8n-oauth2-proxy-app.yaml
