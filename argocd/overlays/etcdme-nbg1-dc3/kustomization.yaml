apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Inherit from base
resources:
  - ../../base
  - n8n-client-setup.yaml
  - playwright-mcp-route.yaml
  - filestash-route.yaml
  - filestash-client-setup.yaml

# KSOPS generator for SOPS-encrypted secrets
# ArgoCD decrypts via KSOPS plugin, kubectl skips this
generators:
  - ksops-generator.yaml

# Domain configuration
configMapGenerator:
  - name: cluster-config
    namespace: default
    literals:
      - domain=etcd.me
      - repo-url=https://github.com/sofianedjerbi/homelab
      - overlay-path=argocd/overlays/etcdme-nbg1-dc3
      - gateway-path=argocd/overlays/etcdme-nbg1-dc3/resources/gateway
      - routes-path=argocd/overlays/etcdme-nbg1-dc3/resources/routes

# Repository configuration - replace placeholders only in apps that use them
replacements:
  - source:
      kind: ConfigMap
      name: cluster-config
      fieldPath: data.repo-url
    targets:
      - select:
          kind: Application
          name: root-app
        fieldPaths:
          - spec.source.repoURL
      - select:
          kind: Application
          name: cilium-gateway
        fieldPaths:
          - spec.source.repoURL
      - select:
          kind: Application
          name: postgres-cluster
        fieldPaths:
          - spec.source.repoURL
      - select:
          kind: Application
          name: argocd-routes
        fieldPaths:
          - spec.source.repoURL
      - select:
          kind: Application
          name: playwright-mcp
        fieldPaths:
          - spec.source.repoURL
      - select:
          kind: Application
          name: filestash
        fieldPaths:
          - spec.source.repoURL
  - source:
      kind: ConfigMap
      name: cluster-config
      fieldPath: data.overlay-path
    targets:
      - select:
          kind: Application
          name: root-app
        fieldPaths:
          - spec.source.path
  - source:
      kind: ConfigMap
      name: cluster-config
      fieldPath: data.gateway-path
    targets:
      - select:
          kind: Application
          name: cilium-gateway
        fieldPaths:
          - spec.source.path
  - source:
      kind: ConfigMap
      name: cluster-config
      fieldPath: data.routes-path
    targets:
      - select:
          kind: Application
          name: argocd-routes
        fieldPaths:
          - spec.source.path

# Patches to replace domain in various resources
# Note: Gateway patches are in overlays/etcdme-nbg1-dc3/resources/gateway/kustomization.yaml
# Note: Route patches are in overlays/etcdme-nbg1-dc3/resources/routes/kustomization.yaml
patches:
  # keycloak-route is managed by root-app, not argocd-routes
  - target:
      kind: HTTPRoute
      name: keycloak-route
    patch: |
      - op: replace
        path: /spec/hostnames/0
        value: auth.etcd.me

  # Keycloak instance - hostname
  - target:
      kind: Keycloak
      name: keycloak
    patch: |
      - op: replace
        path: /spec/hostname/hostname
        value: auth.etcd.me

# Files that are too complex to patch - override entirely
  - path: realm-import.yaml
  - path: loki-stack-app.yaml
  - path: argocd-app.yaml
  - path: cluster-issuer.yaml
  - path: n8n-app.yaml
  - path: n8n-oauth2-proxy-app.yaml
  - path: n8n-route.yaml
  - path: uptime-kuma-route.yaml
  - path: landing-app.yaml
  - path: filestash-patch.yaml
