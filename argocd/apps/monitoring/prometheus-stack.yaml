apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: prometheus-stack
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://prometheus-community.github.io/helm-charts
    chart: kube-prometheus-stack
    targetRevision: 80.9.0
    helm:
      valuesObject:
        alertmanager:
          enabled: true
          config:
            global:
              resolve_timeout: 5m
            route:
              group_by: ['alertname', 'namespace', 'severity']
              group_wait: 30s
              group_interval: 5m
              repeat_interval: 4h
              receiver: 'telegram'
              routes:
                # Ne pas envoyer les alertes Watchdog (heartbeat)
                - matchers:
                    - alertname = "Watchdog"
                  receiver: 'null'
                # Alertes critiques avec rÃ©pÃ©tition plus frÃ©quente
                - matchers:
                    - severity = "critical"
                  receiver: 'telegram'
                  repeat_interval: 1h
            receivers:
              - name: 'null'
              - name: 'telegram'
                telegram_configs:
                  - bot_token_file: /etc/alertmanager/secrets/alertmanager-telegram/bot-token
                    chat_id: 5143700048
                    parse_mode: 'HTML'
                    send_resolved: true
                    message: |
                      {{ if eq .Status "firing" }}ðŸ”¥{{ else }}âœ…{{ end }} <b>{{ .Status | toUpper }}</b>

                      {{ range .Alerts }}
                      <b>Alert:</b> {{ .Labels.alertname }}
                      <b>Severity:</b> {{ .Labels.severity }}
                      {{ if .Labels.namespace }}<b>Namespace:</b> {{ .Labels.namespace }}{{ end }}
                      {{ if .Annotations.summary }}<b>Summary:</b> {{ .Annotations.summary }}{{ end }}
                      {{ if .Annotations.description }}<b>Description:</b> {{ .Annotations.description }}{{ end }}
                      {{ end }}
          alertmanagerSpec:
            secrets:
              - alertmanager-telegram
        nodeExporter:
          enabled: true
        grafana:
          sidecar:
            datasources:
              skipReload: false
          persistence:
            enabled: true
            type: sts
            storageClassName: "longhorn"
            accessModes:
              - ReadWriteOnce
            size: 1Gi
            finalizers:
              - kubernetes.io/pvc-protection

  destination:
    server: https://kubernetes.default.svc
    namespace: monitoring
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - SkipDryRunOnMissingResource=true
      - ServerSideApply=true
