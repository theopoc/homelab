version: '3'

vars:
  OVERLAY: hometheo
  REPO_URL: https://github.com/TheoPoc/homelab

tasks:
  generate-secrets:
    desc: Generate secrets file (requires AWS_* and SOPS_AGE_KEY env vars). Use -- --update to preserve existing passwords.
    cmds:
      - ./tasks/scripts/generate-secrets.sh {{.CLI_ARGS}} {{.OVERLAY}}

  bootstrap:
    desc: Bootstrap ArgoCD (run once after cluster creation)
    cmds:
      - echo "Creating namespaces..."
      - |
        for ns in argocd cert-manager; do
          kubectl create namespace $ns --dry-run=client -o yaml | kubectl apply -f -
        done
      - echo "Applying secrets..."
      - sops -d argocd/overlays/{{.OVERLAY}}/secrets.sops.yaml | kubectl apply -f -
      - echo "Install helm-diff plugin"
      - helm plugin install https://github.com/databus23/helm-diff
      - echo "Installing ArgoCD via Helmfile..."
      - helmfile -f argocd/helmfile.yaml apply
      - echo "Applying root application..."
      - |
        sed -e 's|REPO_URL_PLACEHOLDER|{{.REPO_URL}}|' \
            -e 's|OVERLAY_PATH_PLACEHOLDER|argocd/overlays/{{.OVERLAY}}|' \
            argocd/base/apps/root-app.yaml | kubectl apply -f -
      - echo "âœ… ArgoCD bootstrapped! Sync will start automatically."

  password:
    desc: Get ArgoCD admin password
    cmds:
      - kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d && echo

  secrets:
    desc: Print decrypted secrets from SOPS file
    cmds:
      - sops -d argocd/overlays/{{.OVERLAY}}/secrets.sops.yaml

  keycloak-admin:
    desc: Get Keycloak admin credentials
    cmds:
      - echo "=== Keycloak Admin Credentials ==="
      - echo "URL https://auth.etcd.me"
      - 'echo -n "Username: " && kubectl -n keycloak get secret keycloak-initial-admin -o jsonpath="{.data.username}" | base64 -d && echo'
      - 'echo -n "Password: " && kubectl -n keycloak get secret keycloak-initial-admin -o jsonpath="{.data.password}" | base64 -d && echo'

  grafana-admin:
    desc: Get Grafana admin credentials
    cmds:
      - echo "=== Grafana Admin Credentials ==="
      - echo "URL https://loki.etcd.me"
      - 'echo -n "Username: " && kubectl -n monitoring get secret grafana-admin -o jsonpath="{.data.admin-user}" | base64 -d && echo'
      - 'echo -n "Password: " && kubectl -n monitoring get secret grafana-admin -o jsonpath="{.data.admin-password}" | base64 -d && echo'

  post-bootstrap:
    desc: Show all credentials needed for post-bootstrap setup
    cmds:
      - task: keycloak-admin
      - echo ""
      - task: grafana-admin
      - echo ""
      - task: password
