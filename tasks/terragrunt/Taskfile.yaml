version: '3'

tasks:
  default:
    desc: Run terragrunt command
    summary: |
      Usage:
        task terragrunt -- stack generate terraform/live/hometheo
        task terragrunt -- stack run plan terraform/live/hometheo
        task terragrunt -- stack run apply terraform/live/hometheo
    cmds:
      - |
        ARGS="{{.CLI_ARGS}}"
        DIR="${ARGS##* }"
        CMD="${ARGS% *}"

        if [ -z "$ARGS" ] || [ "$CMD" = "$ARGS" ]; then
          echo "Usage: task terragrunt -- <command> <path>"
          echo ""
          echo "Examples:"
          echo "  task terragrunt -- stack generate terraform/live/hometheo"
          echo "  task terragrunt -- stack run plan terraform/live/hometheo"
          echo "  task terragrunt -- stack run apply terraform/live/hometheo"
          exit 1
        fi

        cd "$DIR" && terragrunt $CMD

  bootstrap:
    desc: Bootstrap S3 backend for Terraform state
    cmds:
      - |
        echo "Bootstrapping S3 backend..."

        if aws s3api head-bucket --bucket "${TF_STATE_BUCKET}" --no-cli-pager 2>/dev/null; then
          echo "✓ Bucket already exists."
        else
          aws s3api create-bucket \
            --bucket "${TF_STATE_BUCKET}" \
            --region "${AWS_REGION}" \
            --no-cli-pager \
            $(if [ "${AWS_REGION}" != "us-east-1" ]; then echo "--create-bucket-configuration LocationConstraint=${AWS_REGION}"; fi)
        fi

        aws s3api put-bucket-versioning --bucket "${TF_STATE_BUCKET}" --versioning-configuration Status=Enabled --no-cli-pager
        aws s3api put-bucket-encryption --bucket "${TF_STATE_BUCKET}" --server-side-encryption-configuration '{"Rules":[{"ApplyServerSideEncryptionByDefault":{"SSEAlgorithm":"AES256"}}]}' --no-cli-pager
        aws s3api put-public-access-block --bucket "${TF_STATE_BUCKET}" --public-access-block-configuration "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true" --no-cli-pager

        echo "✅ Bootstrap complete!"

  clean:
    desc: Clear terragrunt cache
    cmds:
      - |
        echo "Cleaning terragrunt caches..."
        find terraform -type d -name ".terragrunt-cache" -exec rm -rf {} + 2>/dev/null || true
        find terraform -type d -name ".terragrunt-stack" -exec rm -rf {} + 2>/dev/null || true
        echo "✓ Caches cleared"
