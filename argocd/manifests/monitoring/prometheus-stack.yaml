apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: prometheus-stack
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://prometheus-community.github.io/helm-charts
    chart: kube-prometheus-stack
    targetRevision: 80.9.0
    helm:
      valuesObject:
        kubeProxy:
          enabled: false
        defaultRules:
          rules:
            kubeProxy: false
        prometheusOperator:
          resources:
            requests:
              cpu: 10m
              memory: 100Mi
            limits:
              memory: 100Mi
        alertmanager:
          enabled: true
          service:
            annotations:
              tailscale.com/expose: "true"
              tailscale.com/hostname: "prometheus-alertmanager"
          config:
            global:
              resolve_timeout: 5m
            route:
              group_by: ['alertname', 'namespace', 'severity']
              group_wait: 30s
              group_interval: 5m
              repeat_interval: 4h
              receiver: 'telegram'
              routes:
                # Ne pas envoyer les alertes Watchdog (heartbeat)
                - matchers:
                    - alertname = "Watchdog"
                  receiver: 'null'
                # Alertes critiques avec rÃ©pÃ©tition plus frÃ©quente
                - matchers:
                    - severity = "critical"
                  receiver: 'telegram'
                  repeat_interval: 1h
            receivers:
              - name: 'null'
              - name: 'telegram'
                telegram_configs:
                  - bot_token_file: /etc/alertmanager/secrets/alertmanager-telegram/bot-token
                    chat_id: 5143700048
                    parse_mode: 'HTML'
                    send_resolved: true
                    message: |
                      {{ if eq .Status "firing" }}ðŸ”¥{{ else }}âœ…{{ end }} <b>{{ .Status | toUpper }}</b>

                      {{ range .Alerts }}
                      <b>Alert:</b> {{ .Labels.alertname }}
                      <b>Severity:</b> {{ .Labels.severity }}
                      {{ if .Labels.namespace }}<b>Namespace:</b> {{ .Labels.namespace }}{{ end }}
                      {{ if .Annotations.summary }}<b>Summary:</b> {{ .Annotations.summary }}{{ end }}
                      {{ if .Annotations.description }}<b>Description:</b> {{ .Annotations.description }}{{ end }}
                      {{ end }}
          alertmanagerSpec:
            resources:
              requests:
                cpu: 10m
                memory: 100Mi
              limits:
                memory: 100Mi
            secrets:
              - alertmanager-telegram
        kube-state-metrics:
          resources:
            requests:
              cpu: 10m
              memory: 100Mi
            limits:
              memory: 100Mi
        prometheus-node-exporter:
          resources:
            requests:
              cpu: 10m
              memory: 101Mi
            limits:
              memory: 101Mi
        nodeExporter:
          enabled: true
        grafana:
          resources:
            requests:
              cpu: 13m
              memory: 780Mi
            limits:
              memory: 1Gi
          deleteDatasources:
            - name: Loki
              orgId: 1
          additionalDataSources:
            - name: Loki
              type: loki
              url: http://loki-gateway
              access: proxy
              isDefault: false
              jsonData:
                httpHeaderName1: "X-Scope-OrgID"
              secureJsonData:
                httpHeaderValue1: "default"
          sidecar:
            datasources:
              skipReload: false
          persistence:
            enabled: true
            type: sts
            storageClassName: "longhorn"
            accessModes:
              - ReadWriteOnce
            size: 1Gi
            finalizers:
              - kubernetes.io/pvc-protection
        prometheus:
          prometheusSpec:
            resources:
              requests:
                cpu: 435m
                memory: 1913Mi
              limits:
                memory: 1913Mi
          service:
            annotations:
              tailscale.com/expose: "true"
              tailscale.com/hostname: "prometheus"
  destination:
    server: https://kubernetes.default.svc
    namespace: monitoring
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - SkipDryRunOnMissingResource=true
      - ServerSideApply=true
