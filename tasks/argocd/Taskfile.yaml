version: '3'

vars:
  OVERLAY: etcdme-nbg1-dc3
  ARGOCD_VERSION: 9.1.3

tasks:
  generate-secrets:
    desc: Generate secrets file (requires AWS_* and SOPS_AGE_KEY env vars)
    cmds:
      - ./tasks/scripts/generate-secrets.sh {{.OVERLAY}}

  bootstrap:
    desc: Bootstrap ArgoCD (run once after cluster creation)
    cmds:
      - kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
      - echo "Applying secrets..."
      - sops -d argocd/overlays/{{.OVERLAY}}/secrets.sops.yaml | kubectl apply -f -
      - echo "Installing ArgoCD via Helm..."
      - helm repo add argo https://argoproj.github.io/argo-helm || true
      - helm repo update
      - helm upgrade --install argocd argo/argo-cd
          --namespace argocd
          --version {{.ARGOCD_VERSION}}
          --set configs.secret.createSecret=false
          --wait
      - echo "Applying ArgoCD applications..."
      - kubectl apply -k argocd/overlays/{{.OVERLAY}}
      - echo "âœ… ArgoCD bootstrapped!"

  password:
    desc: Get ArgoCD admin password
    cmds:
      - kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d && echo
